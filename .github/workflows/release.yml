name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  APP_NAME: Diduny
  DISPLAY_NAME: Diduny
  SCHEME: Diduny
  PROJECT_FILE: Diduny.xcodeproj
  APP_BUNDLE_NAME: Diduny.app
  ARCHIVE_PATH: build/Diduny.xcarchive
  EXPORT_DIR: build/export
  KEYCHAIN_NAME: build.keychain-db
  USES_XCODEGEN: "true"

jobs:
  release:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: |
          sudo xcode-select -switch /Applications/Xcode.app/Contents/Developer
          xcodebuild -version

      - name: Validate required secrets
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          MACOS_CERTIFICATE_P12: ${{ secrets.MACOS_CERTIFICATE_P12 }}
          MACOS_CERTIFICATE_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
        run: |
          for var in APPLE_ID APPLE_APP_PASSWORD APPLE_TEAM_ID MACOS_CERTIFICATE_P12 MACOS_CERTIFICATE_PASSWORD; do
            if [ -z "${!var}" ]; then
              echo "::error::Missing required secret: ${var}"
              exit 1
            fi
          done

      - name: Import Developer ID certificate
        env:
          MACOS_CERTIFICATE_P12: ${{ secrets.MACOS_CERTIFICATE_P12 }}
          MACOS_CERTIFICATE_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "$MACOS_CERTIFICATE_P12" | base64 --decode > certificate.p12

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_NAME"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security default-keychain -s "$KEYCHAIN_NAME"
          security list-keychains -d user -s "$KEYCHAIN_NAME" login.keychain-db

          security import certificate.p12 \
            -k "$KEYCHAIN_NAME" \
            -P "$MACOS_CERTIFICATE_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/security \
            -T /usr/bin/productbuild

          security set-key-partition-list \
            -S apple-tool:,apple:,codesign: \
            -s \
            -k "$KEYCHAIN_PASSWORD" \
            "$KEYCHAIN_NAME"

          security find-identity -v -p codesigning "$KEYCHAIN_NAME"

      - name: Store notarization credentials
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          xcrun notarytool store-credentials "$APP_NAME" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_APP_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --keychain "$KEYCHAIN_NAME"

      - name: Generate Xcode project (XcodeGen)
        if: env.USES_XCODEGEN == 'true'
        run: |
          brew install xcodegen
          xcodegen generate --quiet

      - name: Resolve packages
        run: xcodebuild -resolvePackageDependencies -project "$PROJECT_FILE" -scheme "$SCHEME"

      - name: Archive universal app
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          xcodebuild archive \
            -project "$PROJECT_FILE" \
            -scheme "$SCHEME" \
            -configuration Release \
            -archivePath "$ARCHIVE_PATH" \
            -destination "generic/platform=macOS" \
            ARCHS="arm64 x86_64" \
            ONLY_ACTIVE_ARCH=NO \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Developer ID Application" \
            DEVELOPMENT_TEAM="$APPLE_TEAM_ID"

      - name: Export and verify app
        run: |
          mkdir -p "$EXPORT_DIR"
          cp -R "$ARCHIVE_PATH/Products/Applications/$APP_BUNDLE_NAME" "$EXPORT_DIR/"

          echo "Architectures:"
          lipo -archs "$EXPORT_DIR/$APP_BUNDLE_NAME/Contents/MacOS/$APP_NAME"

          codesign --verify --deep --strict --verbose=2 "$EXPORT_DIR/$APP_BUNDLE_NAME"

      - name: Notarize and staple
        run: |
          ditto -c -k --keepParent "$EXPORT_DIR/$APP_BUNDLE_NAME" "build/${APP_NAME}-notary.zip"

          xcrun notarytool submit "build/${APP_NAME}-notary.zip" \
            --keychain-profile "$APP_NAME" \
            --keychain "$KEYCHAIN_NAME" \
            --wait

          xcrun stapler staple "$EXPORT_DIR/$APP_BUNDLE_NAME"
          spctl --assess --type exec --verbose "$EXPORT_DIR/$APP_BUNDLE_NAME"

      - name: Create DMG
        run: |
          brew install create-dmg
          VERSION=${GITHUB_REF_NAME#v}

          create-dmg \
            --volname "$DISPLAY_NAME" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "$APP_BUNDLE_NAME" 175 190 \
            --app-drop-link 425 190 \
            "build/${DISPLAY_NAME}-${VERSION}.dmg" \
            "$EXPORT_DIR/"

          cp "build/${DISPLAY_NAME}-${VERSION}.dmg" "build/${DISPLAY_NAME}-latest.dmg"
          shasum -a 256 "build/${DISPLAY_NAME}-${VERSION}.dmg" | awk '{print $1}' > "build/${DISPLAY_NAME}-${VERSION}.sha256"

      - name: Create GitHub release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=${GITHUB_REF_NAME#v}

          gh release create "${GITHUB_REF_NAME}" \
            "build/${DISPLAY_NAME}-${VERSION}.dmg" \
            "build/${DISPLAY_NAME}-latest.dmg" \
            "build/${DISPLAY_NAME}-${VERSION}.sha256" \
            --title "${APP_NAME} ${VERSION}" \
            --generate-notes

      - name: Cleanup signing artifacts
        if: always()
        run: |
          security delete-keychain "$KEYCHAIN_NAME" || true
          rm -f certificate.p12 "build/${APP_NAME}-notary.zip"
